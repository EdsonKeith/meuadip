<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Registro de Associado - ADIP</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Enhanced registration success modal styles */
        #registrationSuccessModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #registrationSuccessModal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: scale(0.7);
            transition: transform 0.3s ease;
        }

        #registrationSuccessModal.show .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .modal-content p {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .form-group.invalid .error-message {
            opacity: 1;
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <div class="logo-hamburger">
                    <div class="logo-container">
                        <img src="Logotipo Monograma Minimalista Cinza e Preto_20250214_185236_0000.png" alt="Logo ADIP" class="nav-logo">
                        <span class="logo-text">Apoio ao Imigrante</span>
                    </div>
                    <button class="hamburger" aria-label="Menu de Navegação">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">Início</a></li>
                    <li><a href="index.html#eventos">Eventos</a></li>
                    <li><a href="index.html#oportunidades">Oportunidades</a></li>
                    <li><a href="index.html" class="btn btn-secondary">Voltar à Página Principal</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="register">
            <div class="container">
                <h2>Torne-se Associado</h2>
                <form id="associadoForm" novalidate>
                    <h3 class="form-title">Formulário de Registro</h3>
                    
                    <div class="form-group" role="group" aria-labelledby="personalInfoLabel">
                        <h4 id="personalInfoLabel">Informações Pessoais</h4>
                        
                        <div class="input-wrapper">
                            <label for="nome">Nome Completo</label>
                            <input 
                                type="text" 
                                id="nome" 
                                name="nome" 
                                required 
                                pattern="^[A-Za-zÀ-ÿ\s]{3,100}$"
                            >
                            <span class="error-message"></span>
                        </div>

                        <div class="input-wrapper">
                            <label for="dataNascimento">Data de Nascimento</label>
                            <input 
                                type="date" 
                                id="dataNascimento" 
                                name="dataNascimento" 
                                required
                                max="2005-01-01"
                                min="1940-01-01"
                            >
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group" role="group" aria-labelledby="contactInfoLabel">
                        <h4 id="contactInfoLabel">Informações de Contato</h4>
                        
                        <div class="input-wrapper">
                            <label for="email">E-mail</label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                required 
                                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                            >
                            <span class="error-message"></span>
                        </div>

                        <div class="input-wrapper">
                            <label for="telefone">Telefone</label>
                            <input 
                                type="tel" 
                                id="telefone" 
                                name="telefone" 
                                required 
                                pattern="(\+\d{2,3})?[\s]?\d{9,11}"
                                placeholder="+351 926 479 393"
                            >
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group" role="group" aria-labelledby="identificationInfoLabel">
                        <h4 id="identificationInfoLabel">Informações de Identificação</h4>
                        
                        <div class="input-wrapper">
                            <label for="identificacao">Número de Identificação</label>
                            <input 
                                type="text" 
                                id="identificacao" 
                                name="identificacao" 
                                required 
                                pattern="^\d{9,14}$"
                            >
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group" role="group" aria-labelledby="addressInfoLabel">
                        <h4 id="addressInfoLabel">Informações de Endereço</h4>
                        
                        <div class="input-wrapper">
                            <label for="endereco">Endereço</label>
                            <textarea 
                                id="endereco" 
                                name="endereco" 
                                required
                                minlength="10"
                            ></textarea>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group" role="group" aria-labelledby="nationalityInfoLabel">
                        <h4 id="nationalityInfoLabel">Informações de Nacionalidade</h4>
                        
                        <div class="input-wrapper">
                            <label for="nacionalidade">Nacionalidade</label>
                            <select 
                                id="nacionalidade" 
                                name="nacionalidade" 
                                required
                            >
                                <option value="">Selecione sua Nacionalidade</option>
                                <option value="Brasil">Brasil</option>
                                <option value="Angola">Angola</option>
                                <option value="Moçambique">Moçambique</option>
                                <option value="Cabo Verde">Cabo Verde</option>
                                <option value="Guiné-Bissau">Guiné-Bissau</option>
                                <option value="São Tomé e Príncipe">São Tomé e Príncipe</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group" role="group" aria-labelledby="interestInfoLabel">
                        <h4 id="interestInfoLabel">Informações de Interesse</h4>
                        
                        <div class="input-wrapper">
                            <label for="interesse">Principal Interesse</label>
                            <select 
                                id="interesse" 
                                name="interesse" 
                                required
                            >
                                <option value="">Selecione seu Principal Interesse</option>
                                <option value="Apoio Legal">Apoio Legal</option>
                                <option value="Integração Social">Integração Social</option>
                                <option value="Oportunidades de Trabalho">Oportunidades de Trabalho</option>
                                <option value="Educação">Educação</option>
                                <option value="Cultura e Comunidade">Cultura e Comunidade</option>
                                <option value="Outro">Outro</option>
                            </select>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group" role="group" aria-labelledby="passwordInfoLabel">
                        <h4 id="passwordInfoLabel">Credenciais de Acesso (Opcional)</h4>
                        
                        <div class="input-wrapper">
                            <label for="password">Senha (opcional)</label>
                            <input 
                                type="password" 
                                id="password" 
                                name="password" 
                                minlength="6"
                                pattern=".{6,}"
                            >
                            <span class="error-message"></span>
                        </div>
                        <p class="hint">
                            Deixe em branco para configurar a senha posteriormente
                        </p>
                    </div>

                    <div class="form-consent">
                        <input 
                            type="checkbox" 
                            id="termos" 
                            name="termos" 
                            required
                        >
                        <label for="termos">
                            Concordo com os 
                            <a href="#" data-modal="termsModal">termos e condições</a>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button 
                            type="submit" 
                            class="btn btn-primary btn-submit"
                            id="submitButton"
                        >
                            Finalizar Cadastro
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Registration Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>

        <!-- Registration Success Modal -->
        <div id="registrationSuccessModal" class="modal">
            <div class="modal-content">
                <h2>Registro Concluído</h2>
                <p>Seu cadastro foi realizado com sucesso!</p>
                <p>Número de Associado: <strong id="associateNumberDisplay"></strong></p>
                <p>Você será redirecionado em breve...</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { 
            getFirestore, 
            collection, 
            addDoc,
            query,
            where,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';

        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Comprehensive Form Validation Function
        function validateRegistrationForm(formData) {
            const errors = {};
            const requiredFields = [
                'nome', 'email', 'telefone', 
                'dataNascimento', 'identificacao', 
                'endereco', 'nacionalidade', 
                'interesse', 'termos'
            ];

            // Validate Required Fields
            requiredFields.forEach(field => {
                if (!formData[field] || formData[field].trim() === '') {
                    errors[field] = `Por favor, preencha o campo ${field}`;
                }
            });

            // Email Validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (formData.email && !emailRegex.test(formData.email)) {
                errors.email = 'Email inválido';
            }

            // Phone Validation
            const phoneRegex = /^(\+\d{2,3})?[\s]?\d{9,11}$/;
            if (formData.telefone && !phoneRegex.test(formData.telefone)) {
                errors.telefone = 'Número de telefone inválido';
            }

            // Age Validation (18 years or older)
            const birthDate = new Date(formData.dataNascimento);
            const minAge = new Date();
            minAge.setFullYear(minAge.getFullYear() - 18);
            
            if (birthDate > minAge) {
                errors.dataNascimento = 'Deve ter pelo menos 18 anos';
            }

            // Identification Number Validation
            const identificationRegex = /^\d{9,14}$/;
            if (formData.identificacao && !identificationRegex.test(formData.identificacao)) {
                errors.identificacao = 'Número de identificação inválido';
            }

            // Terms Agreement
            if (!formData.termos) {
                errors.termos = 'Você precisa aceitar os termos e condições';
            }

            return errors;
        }

        // Generate Unique Associate Number
        function generateUniqueAssociateNumber() {
            const timestamp = Date.now().toString();
            const randomPart = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `ADIP-${timestamp.slice(-6)}-${randomPart}`;
        }

        // Check Email Uniqueness
        async function isEmailUnique(email) {
            const q = query(collection(db, 'associados'), where('email', '==', email));
            const querySnapshot = await getDocs(q);
            return querySnapshot.empty;
        }

        // Form Submission Handler
        document.getElementById('associadoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const registrationSuccessModal = document.getElementById('registrationSuccessModal');
            const associateNumberDisplay = document.getElementById('associateNumberDisplay');

            // Disable submit button and show loading
            submitButton.disabled = true;
            loadingOverlay.style.display = 'flex';

            const formData = new FormData(e.target);
            const associadoData = Object.fromEntries(formData);

            try {
                // Validate form data
                const validationErrors = validateRegistrationForm(associadoData);
                if (Object.keys(validationErrors).length > 0) {
                    // Display validation errors
                    Object.entries(validationErrors).forEach(([field, errorMessage]) => {
                        const input = document.getElementById(field);
                        const errorSpan = input.nextElementSibling || document.createElement('span');
                        errorSpan.classList.add('error-message');
                        errorSpan.textContent = errorMessage;
                        input.parentNode.classList.add('invalid');
                        input.parentNode.insertBefore(errorSpan, input.nextSibling);
                    });
                    
                    submitButton.disabled = false;
                    loadingOverlay.style.display = 'none';
                    return;
                }

                // Check email uniqueness
                const emailIsUnique = await isEmailUnique(associadoData.email);
                if (!emailIsUnique) {
                    const emailInput = document.getElementById('email');
                    const errorSpan = emailInput.nextElementSibling || document.createElement('span');
                    errorSpan.classList.add('error-message');
                    errorSpan.textContent = 'Este email já está registrado';
                    emailInput.parentNode.classList.add('invalid');
                    emailInput.parentNode.insertBefore(errorSpan, emailInput.nextSibling);
                    
                    submitButton.disabled = false;
                    loadingOverlay.style.display = 'none';
                    return;
                }

                // Generate unique associate number
                const associateNumber = generateUniqueAssociateNumber();
                
                // Prepare registration data
                const registrationData = {
                    ...associadoData,
                    associateNumber,
                    dataCadastro: new Date().toISOString(),
                    status: 'Pendente'
                };

                // Remove sensitive or unnecessary fields
                delete registrationData.termos;
                delete registrationData.password;

                // Save to Firestore
                const docRef = await addDoc(collection(db, 'associados'), registrationData);

                // Show registration success modal
                associateNumberDisplay.textContent = associateNumber;
                registrationSuccessModal.classList.add('show');

                // Redirect after 3 seconds
                setTimeout(() => {
                    registrationSuccessModal.classList.remove('show');
                    window.location.href = 'index.html';
                }, 3000);

                // Reset form
                e.target.reset();

            } catch (error) {
                console.error('Erro no registro:', error);
                alert('Erro ao realizar cadastro. Por favor, tente novamente.');
            } finally {
                submitButton.disabled = false;
                loadingOverlay.style.display = 'none';
            }
        });

        // Real-time field validation
        document.querySelectorAll('#associadoForm input, #associadoForm select, #associadoForm textarea')
            .forEach(input => {
                input.addEventListener('input', () => {
                    input.parentNode.classList.remove('invalid');
                    const errorSpan = input.nextElementSibling;
                    if (errorSpan && errorSpan.classList.contains('error-message')) {
                        errorSpan.remove();
                    }
                });
            });
    </script>
</body>
</html>